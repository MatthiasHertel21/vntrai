{% extends "base.html" %}

{% block title %}Edit {{ agent.name }} - Agent{% endblock %}

{% block page_header %}
<div class="page-header max-w-7xl mx-auto w-full">
    <div class="flex justify-between items-center">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold text-lg">
                <img src="{{ url_for('static', filename='icons/Agent - black.png') }}" 
                     class="w-6 h-6" 
                     alt="Agent" 
                     style="filter: brightness(0) invert(1);">
            </div>
            <div>
                <h1 class="text-2xl font-bold text-gray-900" title="Agent ID: {{ agent.id }}&#10;UUID: {{ agent.uuid }}&#10;Created: {{ agent.created_at if agent.created_at else 'Unknown' }}">Edit {{ agent.name }}</h1>
                <p class="text-gray-600">Modify agent configuration and capabilities</p>
            </div>
        </div>
        <div class="flex gap-2">
            <a href="{{ url_for('agents.view_agent', agent_id=agent.id) }}" 
               class="btn btn-outline">
                <i class="bi bi-eye"></i>
                View Agent
            </a>
            <a href="{{ url_for('agents.list_agents') }}" 
               class="btn btn-outline">
                <i class="bi bi-arrow-left"></i>
                Back to Agents
            </a>
            <button type="submit" form="agentEditForm" class="btn btn-primary ml-auto">
                <i class="bi bi-check-lg mr-2"></i>
                Save Changes
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto w-full">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} mb-4">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" id="agentEditForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <!-- Two Column Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Left Column: Basic Information & AI Assistant -->
            <div class="space-y-6">
                <!-- Basic Information -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                    <div class="flex justify-between items-center border-b border-gray-200 pb-2 mb-3">
                        <h3 class="text-lg font-medium text-gray-900 flex items-center">
                            <i class="bi bi-info-circle mr-2 text-blue-500"></i>
                            Basic Information
                        </h3>
                        <div class="flex items-center">
                            <span class="text-sm font-medium text-gray-700 mr-2">Status:</span>
                            <select id="status" 
                                    name="status"
                                    class="px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                <option value="active" {{ 'selected' if agent.status == 'active' }}>Active</option>
                                <option value="inactive" {{ 'selected' if agent.status == 'inactive' }}>Inactive</option>
                                <option value="development" {{ 'selected' if agent.status == 'development' }}>Development</option>
                                <option value="testing" {{ 'selected' if agent.status == 'testing' }}>Testing</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">
                                Agent Name <span class="text-red-500">*</span>
                            </label>
                            <input type="text" 
                                   id="name" 
                                   name="name" 
                                   required
                                   maxlength="100"
                                   value="{{ agent.name }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-700 mb-1">
                                Category
                            </label>
                            <div class="relative">
                                <input type="text" 
                                       id="category" 
                                       name="category"
                                       value="{{ agent.category or '' }}"
                                       list="categoryOptions"
                                       autocomplete="off"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="Enter or select category">
                                <datalist id="categoryOptions">
                                    <option value="General">General</option>
                                    <option value="Content">Content & Writing</option>
                                    <option value="Data">Data Analysis</option>
                                    <option value="Marketing">Marketing</option>
                                    <option value="Research">Research</option>
                                    <option value="Support">Customer Support</option>
                                    <option value="Development">Development</option>
                                    <option value="Finance">Finance</option>
                                    <option value="Education">Education</option>
                                    <option value="Healthcare">Healthcare</option>
                                </datalist>
                            </div>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">
                                Description
                            </label>
                            <textarea id="description" 
                                      name="description" 
                                      rows="3"
                                      maxlength="1000"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="Describe what this agent does...">{{ agent.description or '' }}</textarea>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Use as
                            </label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                <label class="flex items-center">
                                    <input type="checkbox" 
                                           name="use_as_agent" 
                                           value="true"
                                           {% if agent.get('use_as_agent', True) %}checked{% endif %}
                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-600">
                                        <i class="bi bi-person-gear mr-1 text-blue-500"></i>
                                        Agent
                                    </span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" 
                                           name="use_as_insight" 
                                           value="true"
                                           {% if agent.get('use_as_insight', False) %}checked{% endif %}
                                           class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                    <span class="ml-2 text-sm text-gray-600">
                                        <i class="bi bi-lightbulb mr-1 text-purple-500"></i>
                                        Insight
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Assistant Configuration -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex justify-between items-start border-b border-gray-200 pb-3 mb-4">
                        <h3 class="text-lg font-medium text-gray-900 flex items-center">
                            <i class="bi bi-cpu mr-2 text-purple-500"></i>
                            AI Assistant Configuration
                            <span id="assistantStatus" class="ml-2 px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">
                                Not Configured
                            </span>
                        </h3>
                        <div class="relative">
                            <!-- Dropdown toggle button -->
                            <button type="button" 
                                    onclick="toggleActionMenu(this)" 
                                    class="p-1 text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded"
                                    title="Actions">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            
                            <!-- Dropdown menu -->
                            <div class="hidden absolute right-0 top-8 w-36 bg-white border border-gray-200 rounded-md shadow-lg z-10">
                                <button type="button" 
                                        onclick="testAssistantConnection(); toggleActionMenu(this.closest('.relative').querySelector('button'))" 
                                        class="w-full text-left px-3 py-2 text-xs text-blue-600 hover:bg-blue-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                        id="testConnectionBtn" disabled>
                                    <i class="bi bi-wifi mr-1"></i>
                                    Test Connection
                                </button>
                                <button type="button" 
                                        onclick="chatWithAssistant(); toggleActionMenu(this.closest('.relative').querySelector('button'))" 
                                        class="w-full text-left px-3 py-2 text-xs text-green-600 hover:bg-green-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                        id="testChatBtn" disabled>
                                    <i class="bi bi-chat-dots mr-1"></i>
                                    Test Chat
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- AI Assistant Tool und AI Model in einer Zeile -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="ai_assistant_tool" class="block text-sm font-medium text-gray-700 mb-1" 
                                       title="AI Assistant Tool Configuration&#10;Selected tool: {{ agent.ai_assistant_tool or 'None' }}&#10;Assistant ID: {{ agent.assistant_id or 'Not set' }}&#10;Tools with assistant functionality enabled">
                                    AI Assistant Tool <span class="text-red-500">*</span>
                                    <i class="bi bi-info-circle text-gray-400 ml-1" title="Click for configuration details"></i>
                                </label>
                                <select id="ai_assistant_tool" 
                                        name="ai_assistant_tool"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        onchange="onAssistantToolChange(this.value)">
                                    <option value="">Select AI Assistant Tool...</option>
                                    
                                    <!-- Assistant-enabled tools -->
                                    {% if assistant_tools %}
                                        {% for tool in assistant_tools %}
                                        <option value="tool:{{ tool.id }}" {{ 'selected' if agent.ai_assistant_tool == 'tool:' + tool.id }}>
                                            {{ tool.name }} ({{ tool.tool_definition }})
                                        </option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                                <p class="text-xs text-gray-500 mt-1">
                                    Select a tool with AI assistant functionality enabled. 
                                    {% if assistant_tools %}
                                    Found {{ assistant_tools|length }} assistant-enabled tool(s).
                                    {% else %}
                                    No assistant-enabled tools available. <a href="{{ url_for('tools.list_tools') }}" class="text-blue-600 hover:text-blue-800">Configure tools</a> first.
                                    {% endif %}
                                </p>
                            </div>
                            
                            <div>
                                <label for="model" class="block text-sm font-medium text-gray-700 mb-1">
                                    AI Model
                                </label>
                                <select id="model" 
                                        name="model"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="gpt-4o" {{ 'selected' if agent.model == 'gpt-4o' }}>GPT-4o</option>
                                    <option value="gpt-4o-mini" {{ 'selected' if agent.model == 'gpt-4o-mini' }}>GPT-4o Mini</option>
                                    <option value="gpt-4-turbo" {{ 'selected' if agent.model == 'gpt-4-turbo' }}>GPT-4 Turbo</option>
                                    <option value="gpt-4-turbo-preview" {{ 'selected' if agent.model == 'gpt-4-turbo-preview' }}>GPT-4 Turbo Preview</option>
                                    <option value="gpt-4" {{ 'selected' if agent.model == 'gpt-4' }}>GPT-4</option>
                                    <option value="gpt-3.5-turbo" {{ 'selected' if agent.model == 'gpt-3.5-turbo' }}>GPT-3.5 Turbo</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Assistant Tools Auswahl -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="bi bi-tools mr-1 text-blue-500"></i>
                                Assistant Tools
                            </label>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <label class="flex items-center">
                                    <input type="checkbox" 
                                           name="assistant_tools" 
                                           value="file_search"
                                           {% if agent.get('assistant_tools', {}).get('file_search', False) %}checked{% endif %}
                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-600">
                                        <i class="bi bi-file-earmark-search mr-1 text-purple-500"></i>
                                        File Search
                                    </span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" 
                                           name="assistant_tools" 
                                           value="code_interpreter"
                                           {% if agent.get('assistant_tools', {}).get('code_interpreter', False) %}checked{% endif %}
                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-600">
                                        <i class="bi bi-code-slash mr-1 text-green-500"></i>
                                        Code Interpreter
                                    </span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" 
                                           name="assistant_tools" 
                                           value="function_calling"
                                           {% if agent.get('assistant_tools', {}).get('function_calling', False) %}checked{% endif %}
                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-600">
                                        <i class="bi bi-lightning mr-1 text-orange-500"></i>
                                        Functions
                                    </span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" 
                                           name="assistant_tools" 
                                           value="web_browsing"
                                           {% if agent.get('assistant_tools', {}).get('web_browsing', False) %}checked{% endif %}
                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-600">
                                        <i class="bi bi-globe mr-1 text-blue-500"></i>
                                        Web Browsing
                                    </span>
                                </label>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                Select tools that the AI assistant can use during conversations. 
                                <i class="bi bi-info-circle"></i>
                                File Search enables document analysis, Code Interpreter allows code execution.
                            </p>
                        </div>
                        
                        <div>
                            <label for="instructions" class="block text-sm font-medium text-gray-700 mb-1">
                                System Instructions
                            </label>
                            <textarea id="instructions" 
                                      name="instructions" 
                                      rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="System instructions for the AI assistant...">{{ agent.instructions or '' }}</textarea>
                            <p class="text-xs text-gray-500 mt-1">Instructions that define how the AI should behave</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Tasks & Knowledge Base -->
            <div class="space-y-6">
                <!-- Sprint 18: Tasks Management Revolution -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex justify-between items-center border-b border-gray-200 pb-3 mb-4">
                        <div class="flex items-center">
                            <i class="bi bi-list-task mr-2 text-green-500"></i>
                            <h3 class="text-lg font-medium text-gray-900">Tasks</h3>
                            <span class="ml-2 text-sm font-normal text-gray-500">
                                <span id="taskCount">{{ (agent.tasks or [])|length }}</span> tasks
                            </span>
                        </div>
                        <div class="flex gap-2">
                            <button type="button" onclick="addNewTask()" class="btn btn-sm btn-outline w-8 h-8 p-0 flex items-center justify-center" title="Add Task">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Sprint 18: Task List Display - Ultra-Kompakte Version -->
                    <div id="tasksPreview" class="space-y-0.5">
                        {% if agent.tasks %}
                            {% for task in agent.tasks %}
                                <div class="px-2 py-0.5 border border-gray-200 rounded bg-gray-50 hover:bg-gray-100 transition-colors cursor-pointer"
                                     onclick="editTask('{{ task.uuid }}')">
                                    <div class="flex items-center h-7">
                                        <!-- Move buttons at the beginning - wieder vertikal -->
                                        <div class="flex flex-col mr-1.5">
                                            <button type="button" onclick="event.stopPropagation(); moveTaskUp('{{ task.uuid }}')" 
                                                    class="p-0 w-3 h-2.5 text-gray-400 hover:text-gray-600 disabled:opacity-30 flex items-center justify-center"
                                                    {% if loop.first %}disabled{% endif %}
                                                    title="Move task up">
                                                <i class="bi bi-chevron-up" style="font-size: 8px;"></i>
                                            </button>
                                            <button type="button" onclick="event.stopPropagation(); moveTaskDown('{{ task.uuid }}')" 
                                                    class="p-0 w-3 h-2.5 text-gray-400 hover:text-gray-600 disabled:opacity-30 flex items-center justify-center"
                                                    {% if loop.last %}disabled{% endif %}
                                                    title="Move task down">
                                                <i class="bi bi-chevron-down" style="font-size: 8px;"></i>
                                            </button>
                                        </div>
                                        
                                        <!-- Task icon with detailed tooltip - ultra-kompakt -->
                                        {% if task.type == 'ai' %}
                                            <div class="w-4 h-4 bg-blue-100 rounded flex items-center justify-center mr-1.5"
                                                 title="🤖 AI Task Details&#10;━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━&#10;📝 Name: {{ task.name }}&#10;🔧 Type: {{ task.type.upper() }}&#10;🎯 Instructions: {{ task.ai_config.instructions[:150] if task.ai_config and task.ai_config.instructions else 'No instructions provided' }}{{ '...' if task.ai_config and task.ai_config.instructions and task.ai_config.instructions|length > 150 else '' }}&#10;🏆 Goals: {{ task.ai_config.goals[:150] if task.ai_config and task.ai_config.goals else 'No goals specified' }}{{ '...' if task.ai_config and task.ai_config.goals and task.ai_config.goals|length > 150 else '' }}&#10;📤 Output: {{ task.output_description[:100] if task.output_description else 'No output description' }}{{ '...' if task.output_description and task.output_description|length > 100 else '' }}&#10;🔗 UUID: {{ task.uuid }}">
                                                <i class="bi bi-robot text-blue-600" style="font-size: 10px;"></i>
                                            </div>
                                        {% elif task.type == 'tool' %}
                                            <div class="w-4 h-4 bg-purple-100 rounded flex items-center justify-center mr-1.5"
                                                 title="🔧 Tool Task Details&#10;━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━&#10;📝 Name: {{ task.name }}&#10;🔧 Type: {{ task.type.upper() }}&#10;🛠️ Tool: {{ task.tool_config.tool_name if task.tool_config and task.tool_config.tool_name else 'No tool selected' }}&#10;📋 Description: {{ task.description[:150] if task.description else 'No description provided' }}{{ '...' if task.description and task.description|length > 150 else '' }}&#10;📤 Output: {{ task.output_description[:100] if task.output_description else 'No output description' }}{{ '...' if task.output_description and task.output_description|length > 100 else '' }}&#10;🔗 UUID: {{ task.uuid }}">
                                                <i class="bi bi-tools text-purple-600" style="font-size: 10px;"></i>
                                            </div>
                                        {% else %}
                                            <div class="w-4 h-4 bg-gray-100 rounded flex items-center justify-center mr-1.5"
                                                 title="❓ Unknown Task&#10;━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━&#10;📝 Name: {{ task.name }}&#10;🔧 Type: {{ task.type or 'Unknown' }}&#10;📋 Description: {{ task.description[:150] if task.description else 'No description' }}{{ '...' if task.description and task.description|length > 150 else '' }}&#10;🔗 UUID: {{ task.uuid }}">
                                                <i class="bi bi-question text-gray-600" style="font-size: 10px;"></i>
                                            </div>
                                        {% endif %}
                                        
                                        <!-- Task name only - ultra-kompakter -->
                                        <div class="flex-1 min-w-0">
                                            <span class="font-medium text-gray-900 text-sm truncate leading-tight">{{ task.name }}</span>
                                        </div>
                                        
                                        <!-- Delete button only - größer -->
                                        <div class="flex items-center ml-1">
                                            <button type="button" onclick="event.stopPropagation(); deleteTask('{{ task.uuid }}')" 
                                                    class="p-0.5 w-5 h-5 text-red-500 hover:text-red-700 flex items-center justify-center"
                                                    title="Delete task">
                                                <i class="bi bi-trash" style="font-size: 12px;"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-6 text-gray-500">
                                <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                                    <i class="bi bi-plus-circle text-xl text-gray-400"></i>
                                </div>
                                <p class="font-medium">No tasks defined</p>
                                <p class="text-sm mb-4">Define tasks to specify what this agent can do</p>
                                <button type="button" onclick="addNewTask()" class="btn btn-sm btn-primary">
                                    <i class="bi bi-plus mr-1"></i>
                                    Create First Task
                                </button>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Migration Alert for Legacy Agents -->
                    <div id="migrationAlert" class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg hidden">
                        <div class="flex items-start">
                            <i class="bi bi-exclamation-triangle text-yellow-600 mr-2 mt-1"></i>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-yellow-800">Legacy Agent Detected</p>
                                <p class="text-sm text-yellow-700 mt-1">
                                    This agent has legacy instructions. You can migrate them to the new task system.
                                </p>
                                <button type="button" onclick="migrateLegacyInstructions()" class="mt-2 btn btn-sm btn-warning">
                                    <i class="bi bi-arrow-right mr-1"></i>
                                    Migrate to Tasks
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Knowledge Base -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-medium text-gray-900 border-b border-gray-200 pb-3 mb-4 flex items-center">
                        <i class="bi bi-brain mr-2 text-purple-500"></i>
                        Knowledge Base
                        <span class="ml-auto text-sm font-normal text-gray-500">{{ (agent.knowledge_base or [])|length }} items</span>
                    </h3>
                    
                    <div class="space-y-3">
                        {% if agent.knowledge_base %}
                            {% for knowledge in agent.knowledge_base %}
                                <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-medium text-gray-900 mb-1">{{ knowledge.title }}</h4>
                                            {% if knowledge.use_case %}
                                                <p class="text-sm text-gray-600 mb-2">{{ knowledge.use_case }}</p>
                                            {% endif %}
                                            {% if knowledge.rating %}
                                                <div class="flex items-center">
                                                    <span class="text-xs text-gray-500">Rating: {{ knowledge.rating }}/5</span>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="flex gap-1 ml-2">
                                            <button type="button" onclick="editKnowledgeItem('{{ knowledge.id }}')" class="text-blue-500 hover:text-blue-700 text-sm">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button type="button" onclick="deleteKnowledgeItem('{{ knowledge.id }}')" class="text-red-500 hover:text-red-700 text-sm">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-6 text-gray-500">
                                <i class="bi bi-book text-2xl mb-2"></i>
                                <p>No knowledge items</p>
                                <p class="text-sm">Add knowledge to help your agent understand context</p>
                            </div>
                        {% endif %}
                        
                        <button type="button" 
                                onclick="addNewKnowledgeItem()"
                                class="w-full py-2 px-4 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-blue-500 hover:text-blue-500 transition-colors">
                            <i class="bi bi-plus mr-2"></i>
                            Add Knowledge Item
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Auto-save indicator -->
        <div class="text-sm text-gray-500 text-center py-4">
            Last modified: {{ agent.updated_at|format_datetime if agent.updated_at else 'Never' }}
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<!-- Modular JavaScript Includes -->
<script src="{{ url_for('static', filename='js/agents/utilities.js') }}"></script>
<script src="{{ url_for('static', filename='js/agents/input-field-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/agents/tool-integration.js') }}"></script>
<script src="{{ url_for('static', filename='js/agents/task-modals.js') }}"></script>
<script src="{{ url_for('static', filename='js/agents/category-management.js') }}"></script>
<script src="{{ url_for('static', filename='js/agents/assistant-configuration.js') }}"></script>
<script src="{{ url_for('static', filename='js/agents/task-management-advanced.js') }}"></script>
<script src="{{ url_for('static', filename='js/agents/knowledge-management.js') }}"></script>
<script src="{{ url_for('static', filename='js/agents/task-configuration-advanced.js') }}"></script>
<script src="{{ url_for('static', filename='js/agents/form-management.js') }}"></script>

<script>
// Global data injection for modules
window.agentData = {{ agent | tojson | safe }};
window.assistantTools = {{ assistant_tools | tojson | safe if assistant_tools else '[]' }};
window.agentTasks = {{ agent.tasks | tojson | safe if agent.tasks else '[]' }};

// Initialize all modules when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all modular systems
    if (typeof initializeTaskConfiguration === 'function') initializeTaskConfiguration();
    if (typeof initializeAssistantConfiguration === 'function') initializeAssistantConfiguration();
    if (typeof initializeTaskManagement === 'function') initializeTaskManagement(window.agentData);
    
    console.log('Agent edit page modules initialized');
});

// Toggle action menu dropdown
function toggleActionMenu(button) {
    const menu = button.nextElementSibling;
    if (menu.classList.contains('hidden')) {
        // Close any other open menus
        document.querySelectorAll('.relative > div:not(.hidden)').forEach(m => {
            if (m !== menu) m.classList.add('hidden');
        });
        menu.classList.remove('hidden');
        
        // Close menu when clicking outside
        document.addEventListener('click', function closeMenu(e) {
            if (!button.contains(e.target) && !menu.contains(e.target)) {
                menu.classList.add('hidden');
                document.removeEventListener('click', closeMenu);
            }
        });
    } else {
        menu.classList.add('hidden');
    }
}

// Legacy function stubs for backward compatibility
function addNewTaskOld() {
    showNotification('Task creation is now handled through the new Task Editor. This feature will be available in Sprint 18.', false);
    console.log('Add Task clicked - Feature in development for Sprint 18');
}

function deleteTaskOld(taskId) {
    if (confirm('Are you sure you want to delete this task?')) {
        showNotification('Task deletion will be available in Sprint 18.', false);
        console.log('Delete Task clicked for task:', taskId);
    }
}

</script>
{% endblock %}